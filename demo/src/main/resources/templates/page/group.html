<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权限授权界面 - 穿梭框 (已优化)</title>
    <style>
        /* 全局美化和布局 */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* 确保占满整个视口高度 */
        }

        /* 主容器：占用80%的宽和高，并居中 */
        .permission-shuttle-container {
            width: 80vw;
            height: 80vh;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1); /* 阴影更深 */
            display: flex;
            padding: 20px;
            box-sizing: border-box;
        }

        /* 穿梭框组件：未获取/已获取 权限框 */
        .shuttle-box {
            flex: 1; /* 均分宽度 */
            display: flex;
            flex-direction: column;
        }

        .shuttle-box:first-child {
            padding-right: 10px;
        }

        .shuttle-box:last-child {
            padding-left: 10px;
        }

        /* 中间控制区域 */
        .shuttle-controls {
            display: flex;
            flex-direction: column;
            justify-content: center; /* 垂直居中按钮 */
            align-items: center;
            padding: 0 20px;
            gap: 20px; /* 按钮间距 */
        }

        /* 标题样式 */
        .shuttle-box h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #1890ff; /* 蓝色线条 */
            padding-bottom: 5px;
        }

        /* 搜索框和功能区 */
        .controls {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
        }

        .controls input[type="text"] {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .controls input[type="text"]:focus {
            border-color: #1890ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        /* 权限反选按钮美化 (非黄色) */
        .controls button {
            background-color: #faad14; /* 保持橙色用于反选，但可以换成其他颜色，例如 #40a9ff (淡蓝) */
            background-color: #69c0ff; /* 浅蓝色，避免黄色 */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        .controls button:hover {
            background-color: #40a9ff;
        }

        .controls button:active {
            transform: scale(0.98);
        }

        /* 权限列表容器 */
        .permission-list {
            flex-grow: 1;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow-y: auto; /* 容器内部滚动 */
            padding: 5px;
            list-style: none;
            margin: 0;
            background-color: #fdfdfd;
        }

        /* 列表项美化 */
        .permission-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            user-select: none;
        }

        .permission-item:hover {
            background-color: #e6f7ff;
        }

        .permission-item.selected {
            background-color: #bae7ff; /* 浅蓝色表示选中 */
            border-left: 3px solid #1890ff;
        }

        /* 信息文本 */
        .item-info {
            flex-grow: 1;
            margin-left: 10px;
            overflow: hidden;
        }

        .item-info strong {
            display: block;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-info small {
            display: block;
            color: #777;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .permission-item input[type="checkbox"] {
            display: none;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        /* 穿梭按钮美化 (非黄色) */
        .shuttle-controls .move-btn {
            background-color: #1890ff; /* 主色：蓝色 */
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%; /* 圆形按钮 */
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, transform 0.1s;
        }

        .shuttle-controls .move-btn:hover {
            background-color: #40a9ff;
            transform: scale(1.05);
        }

        .shuttle-controls .move-btn:active {
            background-color: #096dd9;
            transform: scale(0.95);
        }

        /* 特殊颜色区分左右移动 */
        #move-right-btn {
            background-color: #52c41a; /* 绿色：表示授予权限 */
        }

        #move-right-btn:hover {
            background-color: #73d13d;
        }

        #move-right-btn:active {
            background-color: #389e0d;
        }

        #move-left-btn {
            background-color: #f5222d; /* 红色：表示撤销权限 */
        }

        #move-left-btn:hover {
            background-color: #ff4d4f;
        }

        #move-left-btn:active {
            background-color: #cf1322;
        }

    </style>
</head>
<body>

<div class="permission-shuttle-container">

    <div class="shuttle-box ungranted-box">
        <h3>未获取权限</h3>
        <div class="controls">
            <input type="text" placeholder="搜索未获取权限..." data-target="ungranted-list"
                   oninput="filterPermissions(this.value, 'ungranted')" id="ungranted-input">
            <button onclick="reverseSelection('ungranted')">权限反选</button>
        </div>
        <ul class="permission-list" id="ungranted-list">
            <div class="empty-message">暂无数据</div>
        </ul>
    </div>

    <div class="shuttle-controls">
        <button id="move-right-btn" class="move-btn" onclick="moveSelected('ungranted')" title="批量授予权限">&gt;
        </button>
        <button id="move-left-btn" class="move-btn" onclick="moveSelected('granted')" title="批量撤销权限">&lt;</button>
    </div>

    <div class="shuttle-box granted-box">
        <h3>已获取权限</h3>
        <div class="controls">
            <input type="text" placeholder="搜索已获取权限..." data-target="granted-list"
                   oninput="filterPermissions(this.value, 'granted')" id="granted-input">
            <button onclick="reverseSelection('granted')">权限反选</button>
        </div>
        <ul class="permission-list" id="granted-list">
            <div class="empty-message">暂无数据</div>
        </ul>
    </div>

</div>

</body>
</html>


<script src="layuiadmin/layui/layui.all.js"></script>
<script src="js/libs.js"></script>
<script>
    let rid = null;
    // --- 1. 初始数据定义 ---
    let ungrantedPermissions = [
        {id: 101, name: "用户管理", desc: "创建、编辑和删除用户账户"},
        {id: 102, name: "商品上架", desc: "在平台发布新商品"},
        {id: 103, name: "订单查看", desc: "查看所有用户的订单信息"},
        {id: 104, name: "财务报表", desc: "访问和导出财务数据"},
        {id: 105, name: "系统配置", desc: "修改后台系统参数"},
        {id: 106, name: "日志审计", desc: "查看操作日志记录"},
        {id: 107, name: "推广活动管理", desc: "设置和管理营销活动"},
        {id: 108, name: "评论审核", desc: "审核和删除用户评论"},
        {id: 109, name: "权限分配", desc: "给其他用户分配权限"},
        {id: 110, name: "数据备份", desc: "执行数据库备份操作"},
    ];

    let grantedPermissions = [
        {id: 201, name: "个人信息修改", desc: "修改自己的密码和资料"},
        {id: 202, name: "通知中心查看", desc: "接收系统通知和消息"},
    ];


    // --- 2. 核心功能函数 ---

    /** 渲染权限列表 */
    function renderPermissions(permissions, listId) {
        const listElement = document.getElementById(listId);
        listElement.innerHTML = '';

        if (permissions.length === 0) {
            listElement.innerHTML = '<div class="empty-message">暂无数据</div>';
            return;
        }

        permissions.forEach(perm => {
            const item = document.createElement('li');
            item.className = 'permission-item';
            item.setAttribute('data-id', perm.id);
            item.setAttribute('data-name', perm.name);
            item.innerHTML = `
                    <input type="checkbox" id="perm-${perm.id}-${listId}" name="permission" value="${perm.id}">
                    <div class="item-info">
                        <strong>${perm.name}</strong>
                        <small>${perm.desc}</small>
                    </div>
                `;

            // 绑定点击选中事件
            item.onclick = (e) => {
                if (e.target.tagName.toLowerCase() !== 'input') {
                    toggleSelection(item);
                }
            };
            // 绑定双击移动事件 (单项快速移动)
            item.ondblclick = () => movePermission([perm.id], listId === 'ungranted-list' ? 'ungranted' : 'granted');

            listElement.appendChild(item);
        });
    }

    /** 切换权限项的选中状态 */
    function toggleSelection(item) {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const isSelected = item.classList.toggle('selected');
        checkbox.checked = isSelected;
    }


    /**
     * 移动权限项 (穿梭框的核心逻辑)
     * @param {Array<number>} ids - 要移动的权限ID数组
     * @param {string} source - 来源列表 ('ungranted' 或 'granted')
     */
    function movePermission(ids, source) {
        if (ids.length === 0) return;

        let itemsToMove = [];
        const isUngrantedSource = source === 'ungranted';
        const sourceArray = isUngrantedSource ? ungrantedPermissions : grantedPermissions;
        const targetArray = isUngrantedSource ? grantedPermissions : ungrantedPermissions;

        // 1. 筛选出要移动的权限并从源数组中移除
        let remaining = [];
        for (const perm of sourceArray) {
            if (ids.includes(perm.id)) {
                itemsToMove.push(perm);
            } else {
                remaining.push(perm);
            }
        }

        // 2. 更新数据模型
        if (isUngrantedSource) {
            ungrantedPermissions = remaining;
            grantedPermissions = targetArray.concat(itemsToMove);
        } else {
            grantedPermissions = remaining;
            ungrantedPermissions = targetArray.concat(itemsToMove);
        }

        // 3. 重新渲染两个列表
        reRenderAll();

        // 4. 执行移动回调
        onPermissionsMoved({
            movedIds: ids,
            from: source,
            to: isUngrantedSource ? 'granted' : 'ungranted',
            currentGranted: grantedPermissions,
            currentUngranted: ungrantedPermissions
        });
    }

    /**
     * 移动所有选中的权限项 (由中间按钮调用)
     * @param {string} source - 来源列表 ('ungranted' 或 'granted')
     */
    function moveSelected(source) {
        const listId = source === 'ungranted' ? 'ungranted-list' : 'granted-list';
        // 只获取当前可见且被选中的项（搜索过滤后的）
        const selectedItems = document.querySelectorAll(`#${listId} .permission-item.selected:not([style*="display: none"])`);
        const selectedIds = Array.from(selectedItems).map(item => (item.getAttribute('data-id')));

        if (selectedIds.length > 0) {
            movePermission(selectedIds, source);
        } else {
            console.log("未选中数据，忽略")
        }
    }

    /** 权限反选功能 */
    function reverseSelection(source) {
        const listId = source === 'ungranted' ? 'ungranted-list' : 'granted-list';
        const allVisibleItems = document.querySelectorAll(`#${listId} .permission-item:not([style*="display: none"])`);

        allVisibleItems.forEach(item => {
            toggleSelection(item);
        });
    }

    /** 搜索/过滤权限功能 */
    function filterPermissions(query, source) {
        const listId = source === 'ungranted' ? 'ungranted-list' : 'granted-list';
        const listElement = document.getElementById(listId);
        const items = listElement.querySelectorAll('.permission-item');
        const lowerCaseQuery = query.toLowerCase().trim();
        let visibleCount = 0;

        items.forEach(item => {
            const name = item.getAttribute('data-name').toLowerCase();
            if (name.includes(lowerCaseQuery)) {
                item.style.display = 'flex';
                visibleCount++;
            } else {
                item.style.display = 'none';
                item.classList.remove('selected'); // 隐藏时取消选中
                item.querySelector('input[type="checkbox"]').checked = false;
            }
        });

        // 处理空消息提示
        const emptyMessage = listElement.querySelector('.empty-message');
        if (emptyMessage) {
            // 如果有查询且没有结果，或者没有查询且数据为空
            const hasData = (source === 'ungranted' ? ungrantedPermissions : grantedPermissions).length > 0;
            if (!hasData) {
                emptyMessage.style.display = 'block'; // 原始列表为空
            } else if (query && visibleCount === 0) {
                emptyMessage.style.display = 'block'; // 搜索无结果
                emptyMessage.textContent = '未找到匹配的权限';
            } else {
                emptyMessage.style.display = 'none'; // 有数据显示
                emptyMessage.textContent = '暂无数据'; // 恢复默认文本
            }
        }
    }

    /** 渲染所有列表，通常在数据变化后调用 */
    function reRenderAll() {

        //document.querySelector('.ungranted-box input[type="text"]').value = '';
        //document.querySelector('.granted-box input[type="text"]').value = '';
        renderPermissions(ungrantedPermissions, 'ungranted-list');
        renderPermissions(grantedPermissions, 'granted-list');

        let data_granted=document.getElementById("granted-input").value;
        if (data_granted != null && data_granted.length > 0) {
            filterPermissions(data_granted,'ungranted')
        }
        let data_ungranted=document.getElementById("ungranted-input").value;
        if (data_ungranted != null && data_ungranted.length > 0) {
            filterPermissions(data_ungranted,'ungranted')
        }
    }

    // --- 3. 移动回调函数 (重要：数据对接出口) ---
    /**
     * 权限移动后的回调函数，用于用户对接后端或更新状态。
     * @param {object} data - 移动详情
     */
    function onPermissionsMoved(data) {
        // 请在此处实现您的数据对接逻辑 (例如调用 API)
        console.log('--- 权限移动回调触发 (onPermissionsMoved) ---');
        console.log(`移动了 ${data.movedIds.length} 个权限，从 [${data.from}] 到 [${data.to}]`);

        // 当前全部已获取权限的ID列表：
        const currentGrantedIds = data.currentGranted.map(p => p.id);
        console.log('当前全部已获取权限ID:', currentGrantedIds);

        let url = `/system/v2/update/group/all?rid=${rid}&type=${data.from == "ungranted" ? 1 : 2}&`;
        for (let id of data.movedIds) {
            url += `gid=${id}&`;
        }
        if (url.endsWith("&")) {
            url = url.substring(0, url.length - 1)
        }
        gzb.get(url, null, function (res) {
            if (!gzb.jsonVerify(res,true)) {
                return;
            }
        })


    }

    // --- 4. 初始化 ---
    document.addEventListener('DOMContentLoaded', async function () {
        rid = gzb.getUrlParar()["id"][0]
        if (rid == null) {
            return;
        }
        let res = await readPermission(rid);
        ungrantedPermissions = res[0];
        grantedPermissions = res[1];
        // 清空搜索框和搜索结果
        reRenderAll();
    });

    function read(data) {
        let arr1 = [];
        let sup = {};
        //sysPermissionSup  sysPermissionType  group all
        for (let json of data) {
            if (json.sysGroupSup == null) {
                continue;
            }
            if (json.sysGroupSup != "0") {
                continue;
            }
            let type = "类型：默认权限";
            arr1.push({id: json.sysGroupId.toString(), name: json.sysGroupName, desc: type + " ; 上级：无"})
            sup[json.sysGroupId.toString()] = json;
        }
        for (let json of data) {
            if (json.sysGroupSup == null) {
                continue;
            }
            if (json.sysGroupSup == "0") {
                continue;
            }
            let type = "类型：默认权限";
            let josn2 = sup[json.sysGroupSup];
            //+" ; 授权自动更新上级权限"
            if (josn2 == null || josn2.sysGroupName == null) {
                arr1.push({id: json.sysGroupId.toString(), name: json.sysGroupName, desc: type + " ; 上级：未知"})
            } else {
                arr1.push({
                    id: json.sysGroupId.toString(),
                    name: json.sysGroupName,
                    desc: type + " ; 上级：" + josn2.sysGroupName
                })
            }
        }
        return arr1;
    }

    async function readPermission(rid) {
        let res = await (await fetch("/system/v2/read/group/all?rid=" + rid)).json();
        if (!gzb.jsonVerify(res)) {
            return;
        }
        console.log(res)
        let res0 = [read(res.data.all), read(res.data.group)];
        return res0;
    }
</script>
